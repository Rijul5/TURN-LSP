{"version":3,"sources":["webpack:///../node_modules/@theia/filesystem/src/browser/download/file-download-command-contribution.ts","webpack:///../node_modules/@theia/filesystem/src/browser/download/file-download-service.ts"],"names":[],"mappings":"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","file":"12.bundle.js","sourcesContent":["/********************************************************************************\n * Copyright (C) 2018 TypeFox and others.\n *\n * This program and the accompanying materials are made available under the\n * terms of the Eclipse Public License v. 2.0 which is available at\n * http://www.eclipse.org/legal/epl-2.0.\n *\n * This Source Code may also be made available under the following Secondary\n * Licenses when the conditions for such availability set forth in the Eclipse\n * Public License v. 2.0 are satisfied: GNU General Public License, version 2\n * with the GNU Classpath Exception which is available at\n * https://www.gnu.org/software/classpath/license.html.\n *\n * SPDX-License-Identifier: EPL-2.0 OR GPL-2.0 WITH Classpath-exception-2.0\n ********************************************************************************/\n\nimport { inject, injectable } from 'inversify';\nimport URI from '@theia/core/lib/common/uri';\nimport { notEmpty } from '@theia/core/lib/common/objects';\nimport { UriSelection } from '@theia/core/lib/common/selection';\nimport { SelectionService } from '@theia/core/lib/common/selection-service';\nimport { Command, CommandContribution, CommandRegistry } from '@theia/core/lib/common/command';\nimport { UriAwareCommandHandler, UriCommandHandler } from '@theia/core/lib/common/uri-command-handler';\nimport { FileDownloadService } from './file-download-service';\n\n@injectable()\nexport class FileDownloadCommandContribution implements CommandContribution {\n\n    @inject(FileDownloadService)\n    protected readonly downloadService: FileDownloadService;\n\n    @inject(SelectionService)\n    protected readonly selectionService: SelectionService;\n\n    registerCommands(registry: CommandRegistry): void {\n        const handler = new UriAwareCommandHandler<URI[]>(this.selectionService, this.downloadHandler(), { multi: true });\n        registry.registerCommand(FileDownloadCommands.DOWNLOAD, handler);\n    }\n\n    protected downloadHandler(): UriCommandHandler<URI[]> {\n        return {\n            execute: uris => this.executeDownload(uris),\n            isEnabled: uris => this.isDownloadEnabled(uris),\n            isVisible: uris => this.isDownloadVisible(uris),\n        };\n    }\n\n    protected async executeDownload(uris: URI[]): Promise<void> {\n        this.downloadService.download(uris);\n    }\n\n    protected isDownloadEnabled(uris: URI[]): boolean {\n        return uris.length > 0 && uris.every(u => u.scheme === 'file');\n    }\n\n    protected isDownloadVisible(uris: URI[]): boolean {\n        return this.isDownloadEnabled(uris);\n    }\n\n    protected getUris(uri: Object | undefined): URI[] {\n        if (uri === undefined) {\n            return [];\n        }\n        return (Array.isArray(uri) ? uri : [uri]).map(u => this.getUri(u)).filter(notEmpty);\n    }\n\n    protected getUri(uri: Object | undefined): URI | undefined {\n        if (uri instanceof URI) {\n            return uri;\n        }\n        if (UriSelection.is(uri)) {\n            return uri.uri;\n        }\n        return undefined;\n    }\n\n}\n\nexport namespace FileDownloadCommands {\n\n    export const DOWNLOAD: Command = {\n        id: 'file.download'\n    };\n\n}\n","/********************************************************************************\n * Copyright (C) 2018 TypeFox and others.\n *\n * This program and the accompanying materials are made available under the\n * terms of the Eclipse Public License v. 2.0 which is available at\n * http://www.eclipse.org/legal/epl-2.0.\n *\n * This Source Code may also be made available under the following Secondary\n * Licenses when the conditions for such availability set forth in the Eclipse\n * Public License v. 2.0 are satisfied: GNU General Public License, version 2\n * with the GNU Classpath Exception which is available at\n * https://www.gnu.org/software/classpath/license.html.\n *\n * SPDX-License-Identifier: EPL-2.0 OR GPL-2.0 WITH Classpath-exception-2.0\n ********************************************************************************/\n\nimport { inject, injectable } from 'inversify';\nimport URI from '@theia/core/lib/common/uri';\nimport { ILogger } from '@theia/core/lib/common/logger';\nimport { Endpoint } from '@theia/core/lib/browser/endpoint';\nimport { StatusBar, StatusBarAlignment } from '@theia/core/lib/browser/status-bar';\nimport { FileSystem } from '../../common/filesystem';\nimport { FileDownloadData } from '../../common/download/file-download-data';\n\n@injectable()\nexport class FileDownloadService {\n\n    protected static PREPARING_DOWNLOAD_ID = 'theia-preparing-download';\n\n    protected anchor: HTMLAnchorElement | undefined;\n    protected downloadQueue: number[] = [];\n    protected downloadCounter: number = 0;\n\n    @inject(ILogger)\n    protected readonly logger: ILogger;\n\n    @inject(FileSystem)\n    protected readonly fileSystem: FileSystem;\n\n    @inject(StatusBar)\n    protected readonly statusBar: StatusBar;\n\n    async download(uris: URI[]): Promise<void> {\n        if (uris.length === 0) {\n            return;\n        }\n        let downloadId: number | undefined;\n        try {\n            downloadId = this.downloadCounter++;\n            if (this.downloadQueue.length === 0) {\n                await this.statusBar.setElement(FileDownloadService.PREPARING_DOWNLOAD_ID, {\n                    alignment: StatusBarAlignment.RIGHT,\n                    text: '$(spinner~spin) Preparing download...',\n                    tooltip: 'Preparing download...',\n                    priority: 1\n                });\n            }\n            this.downloadQueue.push(downloadId);\n            const response = await fetch(this.request(uris));\n            await this.statusBar.removeElement(FileDownloadService.PREPARING_DOWNLOAD_ID);\n            const title = await this.title(response, uris);\n            const { status, statusText } = response;\n            if (status === 200) {\n                await this.forceDownload(response, title);\n            } else {\n                throw new Error(`Received unexpected status code: ${status}. [${statusText}]`);\n            }\n        } catch (e) {\n            this.logger.error(`Error occurred when downloading: ${uris.map(u => u.toString(true))}.`, e);\n        } finally {\n            if (downloadId !== undefined) {\n                const indexOf = this.downloadQueue.indexOf(downloadId);\n                if (indexOf !== -1) {\n                    this.downloadQueue.splice(indexOf, 1);\n                }\n                if (this.downloadQueue.length === 0) {\n                    this.statusBar.removeElement(FileDownloadService.PREPARING_DOWNLOAD_ID);\n                }\n            }\n        }\n    }\n\n    protected async forceDownload(response: Response, title: string): Promise<void> {\n        let url: string | undefined;\n        try {\n            const blob = await response.blob();\n            url = URL.createObjectURL(blob);\n            if (this.anchor === undefined) {\n                this.anchor = document.createElement('a');\n                this.anchor.style.display = 'none';\n            }\n            this.anchor.href = url;\n            this.anchor.download = title;\n            this.anchor.click();\n        } finally {\n            if (url) {\n                URL.revokeObjectURL(url);\n            }\n        }\n    }\n\n    protected async title(response: Response, uris: URI[]): Promise<string> {\n        let title = (response.headers.get('Content-Disposition') || '').split('attachment; filename=').pop();\n        if (title) {\n            return title;\n        }\n        // tslint:disable-next-line:whitespace\n        const [uri,] = uris;\n        if (uris.length === 1) {\n            const stat = await this.fileSystem.getFileStat(uri.toString());\n            if (stat === undefined) {\n                throw new Error(`Unexpected error occurred when downloading file. Files does not exist. URI: ${uri.toString(true)}.`);\n            }\n            title = uri.path.base;\n            return stat.isDirectory ? `${title}.tar` : title;\n        }\n        return `${uri.parent.path.name}.tar`;\n    }\n\n    protected request(uris: URI[]): Request {\n        const url = this.url(uris);\n        const init = this.requestInit(uris);\n        return new Request(url, init);\n    }\n\n    protected requestInit(uris: URI[]): RequestInit {\n        if (uris.length === 1) {\n            return {\n                body: undefined,\n                method: 'GET'\n            };\n        }\n        return {\n            method: 'PUT',\n            body: JSON.stringify(this.body(uris)),\n            headers: new Headers({ 'Content-Type': 'application/json' }),\n        };\n    }\n\n    protected body(uris: URI[]): FileDownloadData {\n        return {\n            uris: uris.map(u => u.toString(true))\n        };\n    }\n\n    protected url(uris: URI[]): string {\n        const endpoint = this.endpoint();\n        if (uris.length === 1) {\n            // tslint:disable-next-line:whitespace\n            const [uri,] = uris;\n            return `${endpoint}/?uri=${uri.toString()}`;\n        }\n        return endpoint;\n\n    }\n\n    protected endpoint(): string {\n        const url = new Endpoint({ path: 'files' }).getRestUrl().toString();\n        return url.endsWith('/') ? url.slice(0, -1) : url;\n    }\n\n}\n"],"sourceRoot":""}